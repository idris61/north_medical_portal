{% extends "templates/web.html" %}

{% block title %}{{ _("Edit Material Issue") }}{% endblock %}

{% block page_content %}
<div class="portal-page">
	<div class="page-header d-flex justify-content-between align-items-center mb-4">
		<div>
			<span class="text-muted small" id="save-status">{{ _("Not Saved") }}</span>
			<h3 class="mb-1 mt-2">{{ _("Edit Material Issue") }}: {{ stock_entry_name }}</h3>
		</div>
		<div>
			<a href="/portal/material-issue" class="btn btn-link">
				{{ _("Back to List") }}
			</a>
		</div>
	</div>

	{% if has_warehouses %}
	<div class="form-container">
		<form id="material-issue-form">
			<!-- Basic Information -->
			<div class="form-section mb-4">
				<div class="row">
					<div class="col-md-6 mb-3">
						<label for="posting-date" class="form-label">
							{{ _("Posting Date") }} <span class="text-danger">*</span>
						</label>
						<input type="date" id="posting-date" class="form-control" required>
					</div>
					<div class="col-md-6 mb-3">
						<label for="warehouse-select" class="form-label">
							{{ _("Source Warehouse") }} <span class="text-danger">*</span>
						</label>
						{% if single_warehouse %}
						<input type="text" id="warehouse-display" class="form-control" 
							value="{{ warehouses[0].warehouse_name or warehouses[0].name }}" readonly>
						<input type="hidden" id="warehouse-select" value="{{ default_warehouse }}">
						{% else %}
						<select id="warehouse-select" class="form-control" required>
							<option value="">{{ _("Select Warehouse") }}</option>
							{% for wh in warehouses %}
							<option value="{{ wh.name }}" {% if default_warehouse == wh.name %}selected{% endif %}>
								{{ wh.warehouse_name or wh.name }}
							</option>
							{% endfor %}
						</select>
						{% endif %}
					</div>
				</div>
			</div>

			<!-- Items -->
			<div class="form-section mb-4">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<h5 class="mb-0">{{ _("Items") }}</h5>
				</div>
				<div class="table-responsive" style="position: relative;">
					<table class="table table-bordered table-hover" id="items-table">
						<thead>
							<tr>
								<th style="width: 5%;" class="text-center">
									<input type="checkbox" id="select-all-items" title="{{ _('Select All') }}">
								</th>
								<th style="width: 5%;" class="text-center">{{ _("Row") }}</th>
								<th style="width: 40%;">
									{{ _("Item") }} <span class="text-danger">*</span>
								</th>
								<th style="width: 15%;">
									{{ _("Quantity") }} <span class="text-danger">*</span>
								</th>
								<th style="width: 15%;">{{ _("Available Stock") }}</th>
								<th style="width: 10%;" class="text-center">{{ _("UOM") }}</th>
							</tr>
						</thead>
						<tbody id="items-tbody">
							<!-- Items will be loaded from API -->
						</tbody>
					</table>
				</div>
				<!-- Autocomplete container - outside table to avoid overflow issues -->
				<div id="item-autocomplete-container" style="display: none; position: absolute; z-index: 10000;"></div>
				<!-- Action buttons at bottom left -->
				<div class="mt-3 d-flex align-items-center">
					<button type="button" id="delete-selected-btn" class="btn btn-sm btn-danger mr-2" style="display: none;">
						<i class="fa fa-trash"></i> {{ _("Delete Selected") }}
					</button>
					<button type="button" id="add-item-btn" class="btn btn-sm btn-secondary">
						<i class="fa fa-plus"></i> {{ _("Add Row") }}
					</button>
				</div>
			</div>

			<!-- Notes -->
			<div class="form-section mb-4">
				<h5 class="mb-3">{{ _("Notes") }}</h5>
				<label for="remarks" class="form-label">{{ _("Description") }}</label>
				<textarea id="remarks" class="form-control" rows="3" 
					placeholder="{{ _('Add optional notes here...') }}"></textarea>
			</div>

			<!-- Form Actions -->
			<div class="form-actions d-flex justify-content-end align-items-center pt-3 border-top">
				<a href="/portal/material-issue" class="btn btn-secondary mr-3">
					{{ _("Cancel") }}
				</a>
				<button type="submit" class="btn btn-primary" id="submit-btn">
					<i class="fa fa-save"></i> {{ _("Update") }}
				</button>
			</div>
		</form>
	</div>

	<!-- Messages -->
	<div id="success-message" class="alert alert-success alert-dismissible fade" role="alert" style="display: none;">
		<strong>{{ _("Success!") }}</strong> <span id="success-text"></span>
		<button type="button" class="close" data-dismiss="alert" aria-label="Close">
			<span aria-hidden="true">&times;</span>
		</button>
	</div>

	<div id="error-message" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
		<strong>{{ _("Error!") }}</strong> <span id="error-text"></span>
		<button type="button" class="close" data-dismiss="alert" aria-label="Close">
			<span aria-hidden="true">&times;</span>
		</button>
	</div>
	{% else %}
	<div class="empty-state text-center py-5">
		<div class="empty-state-icon mb-3">
			<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M20 7h-4M4 7h4m0 0V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-6 0h6m-6 0v10a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V7"/>
			</svg>
		</div>
		<h5>{{ _("No warehouse found") }}</h5>
		<p class="text-muted">{{ _("You don't have access to any warehouse. Please contact your administrator.") }}</p>
		<a href="/portal/material-issue" class="btn btn-secondary mt-3">
			<i class="fa fa-arrow-left mr-1"></i> {{ _("Back to List") }}
		</a>
	</div>
	{% endif %}
</div>

<style>
.portal-page {
	background: #f5f7fa;
	min-height: calc(100vh - 100px);
	padding: 1.5rem;
}

.form-container {
	background: #fff;
	padding: 2rem;
	border-radius: 4px;
	box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.form-section {
	border-bottom: 1px solid #e9ecef;
	padding-bottom: 1.5rem;
}

.form-section:last-of-type {
	border-bottom: none;
}

.form-label {
	font-weight: 600;
	color: #495057;
	margin-bottom: 0.5rem;
	font-size: 0.875rem;
}

.form-control {
	border: 1px solid #d1d5db;
	border-radius: 4px;
	transition: all 0.2s ease;
	font-size: 0.875rem;
}

.form-control:focus {
	border-color: #007bff;
	box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
	outline: none;
}

.form-control:read-only {
	background-color: #f8f9fa;
	cursor: not-allowed;
}

#items-table {
	margin-bottom: 0;
	border: 1px solid #e9ecef;
}

#items-table thead th {
	font-weight: 600;
	color: #495057;
	padding: 0.75rem;
	font-size: 0.875rem;
	border-bottom: 2px solid #dee2e6;
	background: #f8f9fa;
	vertical-align: middle;
	text-align: center;
}

#items-table thead th:first-child,
#items-table thead th:nth-child(2) {
	text-align: center;
}

#items-table thead th:nth-child(3),
#items-table thead th:nth-child(4) {
	text-align: left;
}

#items-table tbody td {
	padding: 0.75rem;
	vertical-align: middle;
	border-top: 1px solid #f0f0f0;
}

#items-table tbody td.text-center {
	text-align: center;
	vertical-align: middle;
}

#items-table thead th {
	vertical-align: middle;
	text-align: center;
}

#items-table thead th:not(.text-center) {
	text-align: left;
}

#items-table tbody tr:hover {
	background-color: #f8f9fa;
}

#items-table .form-control-sm {
	font-size: 0.875rem;
	padding: 0.5rem;
	border: 1px solid #d1d5db;
	border-radius: 4px;
	width: 100%;
}

#items-table .form-control-sm:focus {
	border-color: #007bff;
	box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

#items-table .item-name {
	font-size: 0.75rem;
	margin-top: 0.25rem;
	display: block;
	color: #6c757d;
}

.available-qty {
	font-weight: 500;
	font-size: 0.875rem;
}

.available-qty.low-stock {
	color: #dc3545;
}

.available-qty.in-stock {
	color: #28a745;
}

.item-uom {
	font-size: 0.875rem;
	color: #6c757d;
}

/* Hide number input spinners */
.item-qty::-webkit-outer-spin-button,
.item-qty::-webkit-inner-spin-button {
	-webkit-appearance: none;
	margin: 0;
}

.item-qty {
	-moz-appearance: textfield;
}

.form-actions {
	margin-top: 2rem;
	padding-top: 1.5rem;
}

.btn {
	border-radius: 4px;
	font-weight: 500;
	padding: 0.5rem 1.5rem;
	transition: all 0.2s ease;
}

.btn-primary {
	background-color: #007bff;
	border-color: #007bff;
	color: #fff;
}

.btn-primary:hover {
	background-color: #0056b3;
	border-color: #0056b3;
}

.btn-secondary {
	background-color: #6c757d;
	border-color: #6c757d;
	color: #fff;
}

.btn-secondary:hover {
	background-color: #5a6268;
	border-color: #545b62;
}

.btn-sm {
	padding: 0.25rem 0.75rem;
	font-size: 0.875rem;
}

#add-item-btn {
	display: inline-block !important;
	visibility: visible !important;
	opacity: 1 !important;
}

#delete-selected-btn {
	display: none;
}

#delete-selected-btn.btn-danger {
	background-color: #dc3545;
	border-color: #dc3545;
	color: #fff;
}

#delete-selected-btn.btn-danger:hover {
	background-color: #c82333;
	border-color: #bd2130;
}

.item-checkbox {
	cursor: pointer;
	width: 18px;
	height: 18px;
	margin: 0;
	vertical-align: middle;
}

#select-all-items {
	cursor: pointer;
	width: 18px;
	height: 18px;
	margin: 0;
	vertical-align: middle;
}

.row-number {
	font-weight: 500;
	color: #495057;
}

#items-table tbody td input[type="text"],
#items-table tbody td input[type="number"] {
	vertical-align: middle;
}

.btn-link {
	color: #007bff;
	text-decoration: none;
	padding: 0.5rem 0;
}

.btn-link:hover {
	color: #0056b3;
	text-decoration: none;
}

.btn-link.text-danger {
	color: #dc3545;
}

.btn-link.text-danger:hover {
	color: #c82333;
}

.alert {
	border-radius: 4px;
	border: none;
	border-left: 4px solid;
	margin-bottom: 1rem;
}

.alert-success {
	background-color: #d4edda;
	color: #155724;
	border-left-color: #28a745;
}

.alert-danger {
	background-color: #f8d7da;
	color: #721c24;
	border-left-color: #dc3545;
}

.is-invalid {
	border-color: #dc3545;
}

.is-invalid:focus {
	border-color: #dc3545;
	box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.item-autocomplete {
	position: absolute;
	top: 100%;
	left: 0;
	right: 0;
	background: #fff;
	border: 1px solid #d1d5db;
	border-top: none;
	max-height: 300px;
	overflow-y: auto;
	z-index: 9999;
	box-shadow: 0 4px 6px rgba(0,0,0,0.1);
	width: 100%;
	margin-top: -1px;
	border-radius: 0 0 4px 4px;
}

#item-autocomplete-container {
	background: #fff;
	border: 1px solid #d1d5db;
	max-height: 300px;
	overflow-y: auto;
	box-shadow: 0 4px 12px rgba(0,0,0,0.15);
	border-radius: 4px;
	min-width: 300px;
}

.table-responsive {
	overflow: visible !important;
}

@media (max-width: 768px) {
	.table-responsive {
		overflow-x: auto !important;
	}
}

.item-autocomplete-item {
	padding: 0.75rem;
	cursor: pointer;
	border-bottom: 1px solid #f0f0f0;
	transition: background-color 0.15s ease;
}

.item-autocomplete-item:hover,
.item-autocomplete-item.highlighted {
	background-color: #f8f9fa;
}

.item-autocomplete-item:last-child {
	border-bottom: none;
}

.item-autocomplete-item strong {
	display: block;
	color: #212529;
	font-size: 0.875rem;
}

.item-autocomplete-item small {
	color: #6c757d;
	font-size: 0.75rem;
	display: block;
	margin-top: 0.25rem;
}

.item-autocomplete-item .stock-info {
	color: #28a745;
	font-weight: 500;
	margin-top: 0.25rem;
}

.empty-state {
	padding: 3rem 1rem;
}

.empty-state-icon {
	color: #6c757d;
}

.empty-state h5 {
	color: #495057;
	margin-top: 1rem;
}

.page-header h3 {
	color: #212529;
	font-weight: 600;
}

#save-status {
	font-size: 0.75rem;
	text-transform: uppercase;
	letter-spacing: 0.5px;
}
</style>

<script>
frappe.ready(function() {
	const $form = $('#material-issue-form');
	const $itemsTbody = $('#items-tbody');
	const $warehouseSelect = $('#warehouse-select');
	const $postingDate = $('#posting-date');
	const $addItemBtn = $('#add-item-btn');
	const $submitBtn = $('#submit-btn');
	const stockEntryName = '{{ stock_entry_name }}';
	
	// Initialize warehouse - check both select and hidden input
	let selectedWarehouse = null;
	
	// Check if warehouse select exists and get value
	if ($warehouseSelect.length > 0) {
		selectedWarehouse = $warehouseSelect.val();
	}
	
	// If not found, try to get from hidden input or use default
	if (!selectedWarehouse) {
		const $hiddenWarehouse = $('#warehouse-select[type="hidden"]');
		if ($hiddenWarehouse.length > 0) {
			selectedWarehouse = $hiddenWarehouse.val();
		}
	}
	
	// Fallback to default warehouse from context
	if (!selectedWarehouse && '{{ default_warehouse }}') {
		selectedWarehouse = '{{ default_warehouse }}';
	}
	
	let rowIndex = 1;
	let searchTimeouts = {};
	let autocompleteHighlightIndex = -1;

	// Load existing document data
	frappe.call({
		method: 'north_medical_portal.www.api.stock_entry.get_stock_entry_for_edit',
		args: {
			stock_entry_name: stockEntryName
		},
		callback: function(r) {
			if (r.message) {
				const data = r.message;
				
				// Set posting date
				if (data.posting_date) {
					$postingDate.val(data.posting_date);
				} else {
					const today = new Date().toISOString().split('T')[0];
					$postingDate.val(today);
				}
				
				// Set warehouse
				if (data.warehouse) {
					selectedWarehouse = data.warehouse;
					if ($warehouseSelect.is('select')) {
						$warehouseSelect.val(data.warehouse);
					} else {
						$('#warehouse-select[type="hidden"]').val(data.warehouse);
					}
				}
				
				// Set remarks
				if (data.remarks) {
					$('#remarks').val(data.remarks);
				}
				
				// Load items
				if (data.items && data.items.length > 0) {
					$itemsTbody.empty();
					data.items.forEach(function(item, index) {
						addItemRow(item.item_code, item.item_name, item.qty, item.uom);
					});
					updateRowNumbers();
				} else {
					// Add at least one empty row
					addItemRow();
				}
			}
		},
		error: function(r) {
			showError(r.message || '{{ _("Error loading document") }}');
		}
	});

	// Add item row function
	function addItemRow(itemCode, itemName, qty, uom) {
		const $firstRow = $('.item-row').first();
		const $newRow = $firstRow.length > 0 ? $firstRow.clone(true) : createNewRow();
		
		// Clear and set values
		const rowCount = $('.item-row').length;
		$newRow.find('.row-number').text(rowCount + 1);
		$newRow.find('.item-checkbox').attr('data-row-index', rowCount).prop('checked', false);
		const newInputId = 'item-code-' + Date.now() + '-' + rowIndex++;
		$newRow.find('.item-code').val(itemCode || '').attr('id', newInputId).removeClass('is-invalid');
		if (itemCode) {
			$newRow.find('.item-code').data('item-code', itemCode);
		}
		$newRow.find('.item-qty').val(qty || '').removeClass('is-invalid');
		$newRow.find('.item-name').text(itemName || '').toggle(itemName ? true : false);
		$newRow.find('.available-qty').text('-').removeClass('low-stock in-stock');
		$newRow.find('.item-uom').text(uom || '-');
		
		if ($firstRow.length === 0) {
			$itemsTbody.append($newRow);
		} else {
			$itemsTbody.append($newRow);
		}
		
		// If item code is set, update item info
		if (itemCode && selectedWarehouse) {
			updateItemInfo($newRow, itemCode);
		}
	}

	// Create new row template
	function createNewRow() {
		return $('<tr class="item-row">' +
			'<td class="text-center align-middle">' +
				'<input type="checkbox" class="item-checkbox" data-row-index="0">' +
			'</td>' +
			'<td class="text-center align-middle row-number">1</td>' +
			'<td style="position: relative;">' +
				'<input type="text" class="form-control form-control-sm item-code" ' +
					'placeholder="{{ _('Search item code or name...') }}" ' +
					'autocomplete="off" required>' +
				'<small class="text-muted item-name d-block mt-1" style="display: none;"></small>' +
			'</td>' +
			'<td class="align-middle">' +
				'<input type="number" class="form-control form-control-sm item-qty" ' +
					'step="1" min="1" placeholder="0" required ' +
					'oninput="this.value = this.value.replace(/[^0-9]/g, \'\')">' +
			'</td>' +
			'<td class="align-middle text-center">' +
				'<span class="available-qty text-muted">-</span>' +
			'</td>' +
			'<td class="align-middle text-center">' +
				'<span class="item-uom text-muted">-</span>' +
			'</td>' +
		'</tr>');
	}

	// Warehouse change handler - only if select exists (not hidden input)
	if ($warehouseSelect.length > 0 && $warehouseSelect.is('select')) {
		$warehouseSelect.on('change', function() {
			selectedWarehouse = $(this).val();
			// Clear all item info when warehouse changes
			$('.item-row').each(function() {
				const $row = $(this);
				const itemCode = $row.find('.item-code').data('item-code');
				if (itemCode) {
					updateItemInfo($row, itemCode);
				}
			});
			// Clear all search timeouts
			Object.keys(searchTimeouts).forEach(function(key) {
				clearTimeout(searchTimeouts[key]);
				delete searchTimeouts[key];
			});
		});
	}

	// Clear item row
	function clearItemRow($row) {
		$row.find('.item-code').val('').removeData('item-code').removeClass('is-invalid');
		$row.find('.item-qty').val('').removeAttr('max').removeClass('is-invalid');
		$row.find('.item-name').text('').hide();
		$row.find('.available-qty').text('-').removeClass('low-stock in-stock');
		$row.find('.item-uom').text('-');
		$('#item-autocomplete-container').hide().empty();
	}

	// Function to position autocomplete - relative to input cell, stays fixed
	function positionAutocomplete($input, $container) {
		const $td = $input.closest('td');
		const inputOffset = $input.offset();
		const inputHeight = $input.outerHeight();
		const inputWidth = $input.outerWidth();
		
		// Use fixed positioning relative to viewport
		$container.css({
			position: 'fixed',
			top: (inputOffset.top + inputHeight) + 'px',
			left: inputOffset.left + 'px',
			width: inputWidth + 'px',
			maxHeight: '300px',
			overflowY: 'auto',
			zIndex: 10000
		});
	}

	// Function to search and display items
	function searchAndDisplayItems($input, $row, term) {
		const $autocomplete = $('#item-autocomplete-container');
		const inputId = $input.attr('id') || 'item-code-' + Date.now();
		
		// Clear previous timeout
		if (searchTimeouts[inputId]) {
			clearTimeout(searchTimeouts[inputId]);
			delete searchTimeouts[inputId];
		}
		
		// Ensure warehouse is set
		if (!selectedWarehouse) {
			if ($warehouseSelect.length > 0) {
				selectedWarehouse = $warehouseSelect.val();
			}
			if (!selectedWarehouse) {
				const $hiddenWarehouse = $('#warehouse-select[type="hidden"]');
				if ($hiddenWarehouse.length > 0) {
					selectedWarehouse = $hiddenWarehouse.val();
				}
			}
			if (!selectedWarehouse && '{{ default_warehouse }}') {
				selectedWarehouse = '{{ default_warehouse }}';
			}
			if (!selectedWarehouse) {
				showError('{{ _("Please select a warehouse first") }}');
				$autocomplete.hide().empty();
				return;
			}
		}
		
		// Search items with debounce
		const timeoutId = setTimeout(function() {
			frappe.call({
				method: 'north_medical_portal.www.api.stock.search_items_for_portal',
				args: {
					txt: term || '',
					warehouse: selectedWarehouse,
					page_length: 20
				},
				callback: function(r) {
					if (r.message && r.message.results && r.message.results.length > 0) {
						$autocomplete.empty();
						autocompleteHighlightIndex = -1;
						
						// Position autocomplete
						positionAutocomplete($input, $autocomplete);
						
						r.message.results.forEach(function(result, index) {
							const $item = $('<div class="item-autocomplete-item" data-index="' + index + '"></div>');
							const stockInfo = result[2] || '';
							$item.html(
								'<strong>' + frappe.utils.escape_html(result[0]) + '</strong>' + 
								(result[1] && result[1] !== result[0] ? '<small>' + frappe.utils.escape_html(result[1]) + '</small>' : '') +
								(stockInfo ? '<small class="stock-info">' + frappe.utils.escape_html(stockInfo) + '</small>' : '')
							);
							$item.on('click', function(e) {
								e.preventDefault();
								e.stopPropagation();
								selectItem($row, result[0]);
							});
							$item.on('mouseenter', function() {
								$autocomplete.find('.item-autocomplete-item').removeClass('highlighted');
								$(this).addClass('highlighted');
								autocompleteHighlightIndex = index;
							});
							$autocomplete.append($item);
						});
						$autocomplete.show();
					} else {
						// No results found - show message
						$autocomplete.empty();
						const $noResult = $('<div class="item-autocomplete-item text-muted" style="padding: 0.75rem; cursor: default;">{{ _("No items found") }}</div>');
						$autocomplete.append($noResult);
						positionAutocomplete($input, $autocomplete);
						$autocomplete.show();
					}
					delete searchTimeouts[inputId];
				},
				error: function(r) {
					$autocomplete.hide().empty();
					let errorMsg = '{{ _("Error searching items") }}';
					if (r.message && r.message.exc) {
						errorMsg = r.message.exc;
					} else if (r.message && typeof r.message === 'string') {
						errorMsg = r.message;
					}
					showError(errorMsg);
					delete searchTimeouts[inputId];
				}
			});
		}, term ? 300 : 100); // Faster when no term (focus event)
		
		searchTimeouts[inputId] = timeoutId;
	}

	// Item code autocomplete - on input
	$(document).on('input', '.item-code', function() {
		const $input = $(this);
		const $row = $input.closest('.item-row');
		const term = $input.val().trim();
		
		// If input is cleared, hide autocomplete
		if (!term || term.length < 1) {
			$('#item-autocomplete-container').hide().empty();
			autocompleteHighlightIndex = -1;
			return;
		}
		
		searchAndDisplayItems($input, $row, term);
	});
	
	// Item code autocomplete - on focus (show all items)
	$(document).on('focus', '.item-code', function() {
		const $input = $(this);
		const $row = $input.closest('.item-row');
		const term = $input.val().trim();
		
		// If input is empty, show all items
		if (!term || term.length < 1) {
			searchAndDisplayItems($input, $row, '');
		}
	});
		

	// Handle keyboard navigation in autocomplete
	$(document).on('keydown', '.item-code', function(e) {
		const $input = $(this);
		const $row = $input.closest('.item-row');
		const $autocomplete = $('#item-autocomplete-container');
		const $items = $autocomplete.find('.item-autocomplete-item');
		
		if (e.key === 'ArrowDown') {
			e.preventDefault();
			if ($autocomplete.is(':visible') && $items.length > 0) {
				autocompleteHighlightIndex = Math.min(autocompleteHighlightIndex + 1, $items.length - 1);
				$items.removeClass('highlighted');
				$items.eq(autocompleteHighlightIndex).addClass('highlighted');
				$autocomplete.scrollTop($items.eq(autocompleteHighlightIndex).position().top + $autocomplete.scrollTop() - 50);
			}
		} else if (e.key === 'ArrowUp') {
			e.preventDefault();
			if ($autocomplete.is(':visible') && $items.length > 0) {
				autocompleteHighlightIndex = Math.max(autocompleteHighlightIndex - 1, -1);
				$items.removeClass('highlighted');
				if (autocompleteHighlightIndex >= 0) {
					$items.eq(autocompleteHighlightIndex).addClass('highlighted');
					$autocomplete.scrollTop($items.eq(autocompleteHighlightIndex).position().top + $autocomplete.scrollTop() - 50);
				}
			}
		} else if (e.key === 'Enter') {
			e.preventDefault();
			if ($autocomplete.is(':visible') && $items.length > 0 && autocompleteHighlightIndex >= 0) {
				$items.eq(autocompleteHighlightIndex).click();
			} else {
				const term = $input.val().trim();
				if (term.length >= 1) {
					// Try to select first item or validate
					if ($items.length > 0) {
						$items.first().click();
					} else {
						updateItemInfo($row, term);
					}
				}
			}
		} else if (e.key === 'Escape') {
			$autocomplete.hide().empty();
			autocompleteHighlightIndex = -1;
		}
	});

	// Select item from autocomplete
	function selectItem($row, itemCode) {
		const $input = $row.find('.item-code');
		$input.val(itemCode);
		$input.data('item-code', itemCode);
		$('#item-autocomplete-container').hide().empty();
		autocompleteHighlightIndex = -1;
		updateItemInfo($row, itemCode);
		// Focus on quantity field
		$row.find('.item-qty').focus().select();
	}

	// Hide autocomplete on outside click
	$(document).on('click', function(e) {
		if (!$(e.target).closest('.item-code, #item-autocomplete-container').length) {
			$('#item-autocomplete-container').hide().empty();
			autocompleteHighlightIndex = -1;
		}
	});
	
	// Hide autocomplete when item code loses focus (with delay for click events)
	$(document).on('blur', '.item-code', function() {
		const $input = $(this);
		const $autocomplete = $('#item-autocomplete-container');
		setTimeout(function() {
			if (!$autocomplete.is(':hover') && !$input.is(':focus')) {
				$autocomplete.hide().empty();
				autocompleteHighlightIndex = -1;
			}
		}, 200);
	});
	
	// Reposition autocomplete on scroll - update position when scrolling
	let scrollTimeout;
	$(window).on('scroll', function() {
		const $activeInput = $('.item-code:focus');
		const $autocomplete = $('#item-autocomplete-container');
		if ($activeInput.length > 0 && $autocomplete.is(':visible')) {
			clearTimeout(scrollTimeout);
			scrollTimeout = setTimeout(function() {
				positionAutocomplete($activeInput, $autocomplete);
			}, 10);
		}
	});
	
	// Hide autocomplete on window resize
	$(window).on('resize', function() {
		$('#item-autocomplete-container').hide().empty();
	});

	// Update item info
	function updateItemInfo($row, itemCode) {
		if (!itemCode) {
			itemCode = $row.find('.item-code').data('item-code') || $row.find('.item-code').val().trim();
		}
		
		if (!itemCode || !selectedWarehouse) {
			clearItemRow($row);
			return;
		}

		// Fetch item details and stock info
		frappe.call({
			method: 'north_medical_portal.www.api.stock.get_item_stock_info',
			args: {
				item_code: itemCode,
				warehouse: selectedWarehouse
			},
			callback: function(r) {
				if (r.message) {
					const data = r.message;
					
					// Update item name
					if (data.item_name) {
						$row.find('.item-name').text(data.item_name).show();
					}
					
					// Update stock info
					const availableQty = data.available_qty || 0;
					const actualQty = data.actual_qty || 0;
					
					$row.find('.available-qty').text(Math.round(availableQty));
					$row.find('.available-qty').removeClass('low-stock in-stock');
					
					if (availableQty <= 0) {
						$row.find('.available-qty').addClass('low-stock');
					} else {
						$row.find('.available-qty').addClass('in-stock');
					}
					
					// Set max quantity (integer)
					$row.find('.item-qty').attr('max', Math.round(availableQty));
					
					// Update UOM (already included in response)
					if (data.stock_uom) {
						$row.find('.item-uom').text(data.stock_uom);
					}
					
					// Validate quantity if already entered
					validateQty($row);
				} else {
					clearItemRow($row);
				}
			},
			error: function(r) {
				clearItemRow($row);
				if (r.message && r.message.exc) {
					showError(r.message.exc);
				}
			}
		});
	}

	// Validate quantity
	function validateQty($row) {
		const qty = parseInt($row.find('.item-qty').val()) || 0;
		const maxQty = parseInt($row.find('.item-qty').attr('max')) || 0;
		
		if (qty > 0) {
			if (maxQty > 0 && qty > maxQty) {
				$row.find('.item-qty').addClass('is-invalid');
				showError(`{{ _("Quantity exceeds available stock") }}: ${maxQty}`);
			} else {
				$row.find('.item-qty').removeClass('is-invalid');
			}
		} else if (qty < 0) {
			$row.find('.item-qty').addClass('is-invalid');
		} else {
			$row.find('.item-qty').removeClass('is-invalid');
		}
	}

	// Quantity input handler
	$(document).on('input', '.item-qty', function() {
		validateQty($(this).closest('.item-row'));
	});

	// Add item row
	$addItemBtn.on('click', function(e) {
		e.preventDefault();
		e.stopPropagation();
		addItemRow();
		updateRowNumbers();
		updateDeleteButton();
		
		// Focus on new item code input
		setTimeout(function() {
			$('.item-row').last().find('.item-code').focus();
		}, 100);
	});

	// Delete selected rows
	$('#delete-selected-btn').on('click', function(e) {
		e.preventDefault();
		const selectedRows = $('.item-checkbox:checked').closest('.item-row');
		const rowCount = $('.item-row').length;
		
		if (selectedRows.length === 0) {
			showError('{{ _("Please select at least one row to delete") }}');
			return;
		}
		
		if (selectedRows.length === rowCount) {
			showError('{{ _("Cannot delete all rows. At least one row must remain") }}');
			return;
		}
		
		selectedRows.fadeOut(200, function() {
			$(this).remove();
			updateRowNumbers();
			updateDeleteButton();
			$('#select-all-items').prop('checked', false);
		});
	});

	// Select all checkbox
	$('#select-all-items').on('change', function() {
		const isChecked = $(this).prop('checked');
		$('.item-checkbox').prop('checked', isChecked);
		updateDeleteButton();
	});

	// Individual checkbox change
	$(document).on('change', '.item-checkbox', function() {
		updateDeleteButton();
		// Update select all checkbox
		const totalCheckboxes = $('.item-checkbox').length;
		const checkedCheckboxes = $('.item-checkbox:checked').length;
		$('#select-all-items').prop('checked', totalCheckboxes === checkedCheckboxes && totalCheckboxes > 0);
	});

	// Update delete button visibility
	function updateDeleteButton() {
		const checkedCount = $('.item-checkbox:checked').length;
		if (checkedCount > 0) {
			$('#delete-selected-btn').show();
		} else {
			$('#delete-selected-btn').hide();
		}
	}

	// Update row numbers
	function updateRowNumbers() {
		$itemsTbody.find('.item-row').each(function(index) {
			$(this).find('.row-number').text(index + 1);
			$(this).find('.item-checkbox').attr('data-row-index', index);
		});
	}

	// Form submit
	$form.on('submit', function(e) {
		e.preventDefault();
		
		if (!selectedWarehouse) {
			showError('{{ _("Please select a warehouse") }}');
			return;
		}

		const items = [];
		let hasError = false;

		$('.item-row').each(function() {
			const $row = $(this);
			const itemCode = $row.find('.item-code').data('item-code') || $row.find('.item-code').val().trim();
			const qty = parseInt($row.find('.item-qty').val()) || 0;

			if (!itemCode || qty <= 0) {
				hasError = true;
				$row.find('.item-code, .item-qty').addClass('is-invalid');
				return false;
			}

			const maxQty = parseInt($row.find('.item-qty').attr('max')) || 0;
			if (maxQty > 0 && qty > maxQty) {
				hasError = true;
				$row.find('.item-qty').addClass('is-invalid');
				showError(`{{ _("Quantity exceeds available stock for item") }}: ${itemCode}`);
				return false;
			}

			if (items.find(i => i.item_code === itemCode)) {
				hasError = true;
				$row.find('.item-code').addClass('is-invalid');
				showError(`{{ _("Duplicate item") }}: ${itemCode}`);
				return false;
			}

			items.push({
				item_code: itemCode,
				qty: qty
			});
		});

		if (hasError || items.length === 0) {
			if (!hasError) {
				showError('{{ _("Please enter valid products and quantities") }}');
			}
			return;
		}

		// Submit
		$submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Updating...") }}');
		$('#save-status').text('{{ _("Saving...") }}');
		
		frappe.call({
			method: 'north_medical_portal.www.api.stock_entry.update_stock_entry',
			args: {
				stock_entry_name: stockEntryName,
				warehouse: selectedWarehouse,
				items: items,
				posting_date: $postingDate.val(),
				remarks: $('#remarks').val()
			},
			callback: function(r) {
				$submitBtn.prop('disabled', false).html('<i class="fa fa-save"></i> {{ _("Update") }}');
				
				if (r.message && r.message.name) {
					$('#save-status').text('{{ _("Saved and Submitted") }}');
					showSuccess(`{{ _("Material issue updated and submitted successfully") }}: ${r.message.name}`);
					setTimeout(function() {
						window.location.href = '/portal/material-issue';
					}, 2000);
				} else {
					$('#save-status').text('{{ _("Not Saved") }}');
					showError(r.message && r.message.message ? r.message.message : '{{ _("An error occurred") }}');
				}
			},
			error: function(r) {
				$submitBtn.prop('disabled', false).html('<i class="fa fa-save"></i> {{ _("Update") }}');
				$('#save-status').text('{{ _("Not Saved") }}');
				let errorMsg = '{{ _("An error occurred") }}';
				if (r.message) {
					if (typeof r.message === 'string') {
						errorMsg = r.message;
					} else if (r.message.exc_type) {
						errorMsg = r.message.exc || r.message.message || errorMsg;
					} else {
						errorMsg = r.message.message || errorMsg;
					}
				}
				showError(errorMsg);
			}
		});
	});

	// Show/hide messages
	function showSuccess(message) {
		$('#success-text').text(message);
		$('#success-message').fadeIn().addClass('show');
		$('#error-message').fadeOut().removeClass('show');
		$('html, body').animate({ scrollTop: 0 }, 300);
	}

	function showError(message) {
		$('#error-text').text(message);
		$('#error-message').fadeIn().addClass('show');
		$('#success-message').fadeOut().removeClass('show');
		$('html, body').animate({ scrollTop: 0 }, 300);
	}

	// Initialize on page load
	setTimeout(function() {
		// Ensure buttons are visible - force display
		const $addBtn = $('#add-item-btn');
		if ($addBtn.length > 0) {
			$addBtn.css({
				'display': 'inline-block',
				'visibility': 'visible',
				'opacity': '1'
			}).show();
		}
		
		// Ensure warehouse is set
		if (!selectedWarehouse) {
			const $wh = $('#warehouse-select');
			if ($wh.length > 0) {
				selectedWarehouse = $wh.val();
			}
			if (!selectedWarehouse && '{{ default_warehouse }}') {
				selectedWarehouse = '{{ default_warehouse }}';
			}
		}
		
		// Update row numbers
		updateRowNumbers();
		
		// Initialize delete button state
		updateDeleteButton();
	}, 500);
});
</script>
{% endblock %}

