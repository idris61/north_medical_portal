{% extends "templates/web.html" %}

{% block title %}{{ _("Material Issue") }}{% endblock %}

{% block page_content %}
<div class="portal-page">
	<div class="page-header d-flex justify-content-between align-items-center mb-4">
		<h3 class="mb-0">{{ _("Material Issue") }}</h3>
		<a href="/portal/material-issue/new" class="btn btn-primary">
			<i class="fa fa-plus"></i> {{ _("Create New") }}
		</a>
	</div>

	{% if has_entries %}
	<div class="website-list">
		{% for entry in stock_entries %}
		<div class="web-list-item transaction-list-item" data-entry-name="{{ entry.name }}" data-docstatus="{{ entry.docstatus }}">
			<a href="/portal/stock-entry/{{ entry.name }}" class="transaction-item-link"></a>
			<div class="row align-items-center">
				<div class="col-sm-3">
					<span class="list-item-name font-weight-bold">{{ entry.name }}</span>
					<div class="small text-muted transaction-time">
						{{ frappe.format_date(entry.posting_date) if entry.posting_date else frappe.format_date(entry.creation) }}
					</div>
				</div>
				<div class="col-sm-2">
					{% if entry.docstatus == 0 %}
						<span class="indicator-pill gray list-item-status">{{ _("Draft") }}</span>
					{% elif entry.docstatus == 1 %}
						<span class="indicator-pill blue list-item-status">{{ _("Submitted") }}</span>
					{% elif entry.docstatus == 2 %}
						<span class="indicator-pill red list-item-status">{{ _("Cancelled") }}</span>
					{% endif %}
				</div>
				<div class="col-sm-4">
					<div class="small text-muted">
						{{ _("Warehouse") }}: {{ entry.warehouse_display or entry.to_warehouse or entry.from_warehouse or "-" }}
					</div>
					{% if entry.remarks %}
					<div class="small text-muted">
						{{ entry.remarks[:50] }}{% if entry.remarks|length > 50 %}...{% endif %}
					</div>
					{% endif %}
				</div>
				<div class="col-sm-3 text-right">
					<div class="action-buttons">
						{% if entry.docstatus == 0 %}
							<button type="button" class="btn btn-sm btn-primary edit-btn" 
								data-entry-name="{{ entry.name }}" 
								title="{{ _('Edit') }}"
								onclick="editStockEntry('{{ entry.name }}', this); return false;"
								style="position: relative; z-index: 20; cursor: pointer;">
								<i class="fa fa-edit"></i> {{ _("Edit") }}
							</button>
							<button type="button" class="btn btn-sm btn-danger delete-btn" 
								data-entry-name="{{ entry.name }}" 
								title="{{ _('Delete') }}"
								onclick="deleteStockEntry('{{ entry.name }}', this); return false;"
								style="position: relative; z-index: 20; cursor: pointer;">
								<i class="fa fa-trash"></i> {{ _("Delete") }}
							</button>
						{% elif entry.docstatus == 1 %}
							<button type="button" class="btn btn-sm btn-warning cancel-btn" 
								data-entry-name="{{ entry.name }}" 
								title="{{ _('Cancel') }}"
								onclick="cancelStockEntry('{{ entry.name }}', this); return false;"
								style="position: relative; z-index: 20; cursor: pointer;">
								<i class="fa fa-ban"></i> {{ _("Cancel") }}
							</button>
						{% elif entry.docstatus == 2 %}
							<button type="button" class="btn btn-sm btn-primary amend-btn" 
								data-entry-name="{{ entry.name }}" 
								title="{{ _('Amend') }}"
								onclick="amendStockEntry('{{ entry.name }}', this); return false;"
								style="position: relative; z-index: 20; cursor: pointer;">
								<i class="fa fa-edit"></i> {{ _("Amend") }}
							</button>
							<button type="button" class="btn btn-sm btn-danger delete-btn" 
								data-entry-name="{{ entry.name }}" 
								title="{{ _('Delete') }}"
								onclick="deleteStockEntry('{{ entry.name }}', this); return false;"
								style="position: relative; z-index: 20; cursor: pointer;">
								<i class="fa fa-trash"></i> {{ _("Delete") }}
							</button>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
		{% endfor %}
	</div>
	{% else %}
	<div class="empty-state text-center py-5">
		<div class="empty-state-icon mb-3">
			<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M20 7h-4M4 7h4m0 0V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-6 0h6m-6 0v10a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V7"/>
			</svg>
		</div>
		<h5>{{ _("No material issue found") }}</h5>
		<p class="text-muted">{{ _("No material issue has been created yet") }}</p>
		<a href="/portal/material-issue/new" class="btn btn-primary mt-3">
			<i class="fa fa-plus"></i> {{ _("Create New") }}
		</a>
	</div>
	{% endif %}
</div>

<style>
.website-list {
	background-color: var(--fg-color);
	padding: 0 var(--padding-lg);
	border-radius: var(--border-radius-md);
}

.transaction-list-item {
	padding: 1rem 0;
	border-bottom: 1px solid var(--border-color);
	position: relative;
	cursor: pointer;
}

.transaction-list-item:hover {
	background-color: #f8f9fa;
}

.transaction-list-item > .row {
	cursor: pointer;
}

.transaction-list-item:only-child,
.transaction-list-item:last-child {
	border: 0;
}

.transaction-item-link {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	text-decoration: none;
	opacity: 0;
	overflow: hidden;
	text-indent: -9999px;
	z-index: 1;
	pointer-events: auto;
}

.transaction-list-item > .row {
	position: relative;
	z-index: 0;
	pointer-events: none;
}

.transaction-list-item > .row > * {
	pointer-events: none;
}

.transaction-list-item .btn,
.transaction-list-item button {
	position: relative;
	z-index: 2;
	pointer-events: auto !important;
}


.list-item-name {
	font-size: var(--font-size-sm);
	color: var(--text-color);
}

.transaction-time {
	margin-top: 0.25rem;
}

.indicator-pill {
	display: inline-flex;
	align-items: center;
	padding: 0.375rem 0.875rem;
	border-radius: 1rem;
	font-size: 0.875rem;
	font-weight: 500;
	line-height: 1.2;
	vertical-align: middle;
}

.indicator-pill.gray {
	background-color: #e0e0e0;
	color: #666;
}

.indicator-pill.green {
	background-color: #d4edda;
	color: #155724;
}

.indicator-pill.red {
	background-color: #f8d7da;
	color: #721c24;
}

.indicator-pill.blue {
	background-color: #e3f2fd;
	color: #1976d2;
}

.list-item-status {
	display: inline-flex;
	align-items: center;
	justify-content: center;
}

.action-buttons {
	display: flex;
	gap: 0.5rem;
	justify-content: flex-end;
	flex-wrap: wrap;
	position: relative;
	z-index: 2;
}

.action-buttons .btn,
.action-buttons a.btn {
	white-space: nowrap;
	position: relative;
	z-index: 2;
	text-decoration: none;
	cursor: pointer;
	pointer-events: auto !important;
}

.transaction-list-item:hover .action-buttons {
	opacity: 1;
}

.action-buttons {
	opacity: 0.7;
	transition: opacity 0.2s;
}
</style>

<script>
// Global function for edit button (inline onclick)
function editStockEntry(entryName, btnElement) {
	if (!entryName) {
		frappe.show_alert({
			message: '{{ _("Document name not found") }}',
			indicator: 'red'
		}, 5);
		return false;
	}
	
	window.location.href = '/portal/material-issue/edit/' + entryName;
	return false;
}

// Global function for delete button (inline onclick)
function deleteStockEntry(entryName, btnElement) {
	if (!entryName) {
		frappe.show_alert({
			message: '{{ _("Document name not found") }}',
			indicator: 'red'
		}, 5);
		return false;
	}
	
	var $btn = $(btnElement);
	
	if (confirm('{{ _("Are you sure you want to delete this document?") }}')) {
		$btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Deleting...") }}');
		
		frappe.call({
			method: 'north_medical_portal.www.api.stock_entry.delete_stock_entry',
			args: {
				stock_entry_name: entryName
			},
			callback: function(r) {
				if (r.message) {
					frappe.show_alert({
						message: r.message.message || '{{ _("Document deleted successfully") }}',
						indicator: 'green'
					}, 3);
					setTimeout(function() {
						location.reload();
					}, 1000);
				} else {
					$btn.prop('disabled', false).html('<i class="fa fa-trash"></i> {{ _("Delete") }}');
					frappe.show_alert({
						message: '{{ _("An error occurred") }}',
						indicator: 'red'
					}, 5);
				}
			},
			error: function(r) {
				$btn.prop('disabled', false).html('<i class="fa fa-trash"></i> {{ _("Delete") }}');
				var errorMsg = '{{ _("An error occurred") }}';
				if (r.message) {
					if (typeof r.message === 'string') {
						errorMsg = r.message;
					} else if (r.message.exc) {
						errorMsg = r.message.exc;
					} else if (r.message.message) {
						errorMsg = r.message.message;
					}
				}
				frappe.show_alert({
					message: errorMsg,
					indicator: 'red'
				}, 5);
			}
		});
	}
	
	return false;
}

// Global function for cancel button (inline onclick)
function cancelStockEntry(entryName, btnElement) {
	if (!entryName) {
		frappe.show_alert({
			message: '{{ _("Document name not found") }}',
			indicator: 'red'
		}, 5);
		return false;
	}
	
	var $btn = $(btnElement);
	
	if (confirm('{{ _("Are you sure you want to cancel this document?") }}')) {
		$btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Cancelling...") }}');
		
		frappe.call({
			method: 'north_medical_portal.www.api.stock_entry.cancel_stock_entry',
			args: {
				stock_entry_name: entryName
			},
			callback: function(r) {
				if (r.message) {
					frappe.show_alert({
						message: r.message.message || '{{ _("Document cancelled successfully") }}',
						indicator: 'green'
					}, 3);
					setTimeout(function() {
						location.reload();
					}, 1000);
				} else {
					$btn.prop('disabled', false).html('<i class="fa fa-ban"></i> {{ _("Cancel") }}');
					frappe.show_alert({
						message: '{{ _("An error occurred") }}',
						indicator: 'red'
					}, 5);
				}
			},
			error: function(r) {
				$btn.prop('disabled', false).html('<i class="fa fa-ban"></i> {{ _("Cancel") }}');
				var errorMsg = '{{ _("An error occurred") }}';
				if (r.message) {
					if (typeof r.message === 'string') {
						errorMsg = r.message;
					} else if (r.message.exc) {
						errorMsg = r.message.exc;
					} else if (r.message.message) {
						errorMsg = r.message.message;
					}
				}
				frappe.show_alert({
					message: errorMsg,
					indicator: 'red'
				}, 5);
			}
		});
	}
	
	return false;
}

// Global function for amend button (inline onclick)
function amendStockEntry(entryName, btnElement) {
	if (!entryName) {
		frappe.show_alert({
			message: '{{ _("Document name not found") }}',
			indicator: 'red'
		}, 5);
		return false;
	}
	
	var $btn = $(btnElement);
	
	if (confirm('{{ _("This will create a new document based on the cancelled one. Continue?") }}')) {
		$btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Creating...") }}');
		
		frappe.call({
			method: 'north_medical_portal.www.api.stock_entry.amend_stock_entry',
			args: {
				stock_entry_name: entryName
			},
			callback: function(r) {
				if (r.message && r.message.name) {
					frappe.show_alert({
						message: r.message.message || '{{ _("Document amended successfully") }}',
						indicator: 'green'
					}, 3);
					// Mevcut belgeyi düzenleme sayfasına yönlendir
					setTimeout(function() {
						window.location.href = '/portal/material-issue/edit/' + r.message.name;
					}, 500);
				} else {
					$btn.prop('disabled', false).html('<i class="fa fa-edit"></i> {{ _("Amend") }}');
					frappe.show_alert({
						message: '{{ _("An error occurred") }}',
						indicator: 'red'
					}, 5);
				}
			},
			error: function(r) {
				$btn.prop('disabled', false).html('<i class="fa fa-edit"></i> {{ _("Amend") }}');
				var errorMsg = '{{ _("An error occurred") }}';
				if (r.message) {
					if (typeof r.message === 'string') {
						errorMsg = r.message;
					} else if (r.message.exc) {
						errorMsg = r.message.exc;
					} else if (r.message.message) {
						errorMsg = r.message.message;
					}
				}
				frappe.show_alert({
					message: errorMsg,
					indicator: 'red'
				}, 5);
			}
		});
	}
	
	return false;
}

$(document).ready(function() {
	// İptal butonu - backup handler (inline onclick zaten var ama yine de ekliyoruz)
	$(document).on('click', '.cancel-btn', function(e) {
		e.preventDefault();
		e.stopPropagation();
		e.stopImmediatePropagation();
		
		var entryName = $(this).data('entry-name');
		if (entryName) {
			cancelStockEntry(entryName, this);
		}
		
		return false;
	});
	
	// Düzenle butonu - backup handler (inline onclick zaten var)
	$(document).on('click', '.edit-btn', function(e) {
		e.preventDefault();
		e.stopPropagation();
		e.stopImmediatePropagation();
		
		var entryName = $(this).data('entry-name');
		if (entryName) {
			editStockEntry(entryName, this);
		}
		
		return false;
	});
	
	// Sil butonu - backup handler (inline onclick zaten var)
	$(document).on('click', '.delete-btn', function(e) {
		e.preventDefault();
		e.stopPropagation();
		e.stopImmediatePropagation();
		
		var entryName = $(this).data('entry-name');
		if (entryName) {
			deleteStockEntry(entryName, this);
		}
		
		return false;
	});
	
	// Amend butonu - backup handler (inline onclick zaten var)
	$(document).on('click', '.amend-btn', function(e) {
		e.preventDefault();
		e.stopPropagation();
		e.stopImmediatePropagation();
		
		var entryName = $(this).data('entry-name');
		if (entryName) {
			amendStockEntry(entryName, this);
		}
		
		return false;
	});
	
	// Butonlara tıklandığında link'in çalışmasını engelle
	$(document).on('click', '.action-buttons, .action-buttons *', function(e) {
		e.stopPropagation();
	});
});
</script>
{% endblock %}
